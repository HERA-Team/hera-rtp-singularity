# =============================================================================
# Definition file for a singularity container for HERA RTP
# This containe consists of a miniconda base with:
#   pyuvdata (https://github.com/RadioAstronomySoftwareGroup/pyuvdata/)
#   linsolve (https://github.com/HERA-Team/linsolve)
#   uvtools (https://github.com/HERA-Team/uvtools)
#   hera_cal (https://github.com/HERA-Team/hera_cal)
#   hera_qm (https://github.com/HERA-Team/hera_qm)
#   hera_opm (https://github.com/HERA-Team/hera_opm)
#   hera_pipelines (https://github.com/HERA-Team/hera_pipelines)
#   hera_notebook_templates (https://github.com/HERA-Team/hera_notebook_templates)
#   hera_mc (https://github.com/HERA-Team/hera_mc; required by hera_notebook_templates)
# =============================================================================
Bootstrap: docker
From: ubuntu:18.04


# Commands to be executed on the host system outside of the container after the base OS has been installed.
# %setup


# Copy files from the host system to the container
# %files


# Define environment variables that will be set at runtime.
# %environment
  # Not really sure which locale should be set in the container ...
  # export LC_ALL=C


# Commands to be executed at build time after the base OS has been installed.
# These commands are executed as root in /root inside the container.
%post
  # Update Ubuntu packages and install neccesary packages
  apt-get update
  apt-get install -y wget
  # apt-get clean
  # DONE with OS install and update

  # Download and install miniconda
  cd /usr/local
  wget https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh
  # Define environment variable for conda install path
  # CONDA_INSTALL_PATH="/usr/local/miniconda3"
  # bash Miniconda3-latest-Linux-x86_64.sh -b -p $CONDA_INSTALL_PATH

#   # Make conda executable available during build.
#   # This does not make the executable available during runtime.
#   export PATH="$CONDA_INSTALL_PATH/bin:$PATH"
#
#   # Make sure conda is up-to-date
#   conda update -n base conda
#
#   # Install dependencies for HEREA packages.
#   # All dependencies are available in conda although the conda epheem
#   # package seems to be too old for hera_cal.
#   conda install -c conda-forge numpy scipy scikit-learn h5py astropy aipy \
#     pyyaml matplotlib ephem pandas cartopy sqlalchemy psycopg2 alembic \
#     python-dateutil tabulate psutil redis-py setuptools_scm mako
#   # pyuvdata gets an honourable mention here
#   conda install -c conda-forge pyuvdata
#
#   # Install hera_packages
#   # To give user some flexibility, we will git clone and pip install .
#   # The source codes will be cloned to /usr/local/hera
#   # Define environment variable for the install path for hera packages
#   HERA_INSTALL_PATH="/usr/local/hera"
#   mkdir $HERA_INSTALL_PATH
#   cd $HERA_INSTALL_PATH
#   # linsolve is used in most hera software packages and should be installed first
#   # hera_qm should be installed before hera_cal as the latter requires the former
#   # hera_mc installation has a step that sets up database configuration file,
#   # which is not currently done and not sure if it will be needed ...
#   for pkg in linsolve uvtools hera_qm hera_cal hera_opm hera_mc hera_notebook_templates
#   do
#     git clone https://github.com/HERA-Team/$pkg
#     cd $pkg
#     pip install .
#     cd ..
#   done
#   # Only need to clone hera_pipelines
#   git clone https://github.com/HERA-Team/hera_pipelines
#
#   # The shell in singularity runs in a special environment, so the standard
#   # conda modifications to the .bashrc do not work. We need to modify the
#   # $SINGULARITY_ENVIRONMENT variable to make the containeer sources
#   # the conda modification script at runtime
#   echo ". $CONDA_INSTALL_PATH/etc/profile.d/conda.sh" >> $SINGULARITY_ENVIRONMENT
#
#   # Also export HERA_INSTALL_PATH and CONDA_INSTALL_PATH variables to the container
#   echo 'export HERA_INSTALL_PATH=$HERA_INSTALL_PATH' >> $SINGULARITY_ENVIRONMENT
#   echo 'export CONDA_INSTALL_PATH=$CONDA_INSTALL_PATH' >> $SINGULARITY_ENVIRONMENT
#
#   # List installed environments and check environment variables at start
#   echo "Done building HERA RTP singularity container"
#   echo "miniconda installed path is $CONDA_INSTALL_PATH"
#   echo "HERA packages path is $HERA_INSTALL_PATH"
#   conda env list


# The contents of the %runscript section are written to a file within the
# container that is executed when the container image is run (either via the
# `singularity run` command or by executing the container directly as a command).
# %runscript


# The contents of the %startscript section are written to a file within
# the container at build time, and this file is executed when the instance
# start command is issued. The instance command run the container as a deamon.
# %startscript


# Commands in %test are run at the very end of the build process and can be
# turned off with --notest tag in singularity commands
# %test


# %labels
#   Author The HERRA Collaboration
#   Version v0.0.1


# %help
#   This is a container for HERA RTP
